import asyncio
import websockets
import json, logging, os
import time
import threading
import schedule
import random

from functools import partial

from utils.common import Common
from utils.logger import Configure_logger
from utils.my_handle import My_handle
from utils.config import Config


config = None
common = None
my_handle = None
last_liveroom_data = None
last_username_list = None


def start_server():
    global config, common, my_handle, last_liveroom_data, last_username_list

    config_path = "config.json"

    config = Config(config_path)
    common = Common()
    # æ—¥å¿—æ–‡ä»¶è·¯å¾„
    log_path = "./log/log-" + common.get_bj_time(1) + ".txt"
    Configure_logger(log_path)

    # æœ€æ–°çš„ç›´æ’­é—´æ•°æ®
    last_liveroom_data = {
        'OnlineUserCount': 0, 
        'TotalUserCount': 0, 
        'TotalUserCountStr': '0', 
        'OnlineUserCountStr': '0', 
        'MsgId': 0, 
        'User': None, 
        'Content': 'å½“å‰ç›´æ’­é—´äººæ•° 0ï¼Œç´¯è®¡ç›´æ’­é—´äººæ•° 0', 
        'RoomId': 0
    }
    # æœ€æ–°å…¥åœºçš„ç”¨æˆ·ååˆ—è¡¨
    last_username_list = [""]

    my_handle = My_handle(config_path)
    if my_handle is None:
        logging.error("ç¨‹åºåˆå§‹åŒ–å¤±è´¥ï¼")
        os._exit(0)


    # æ·»åŠ ç”¨æˆ·ååˆ°æœ€æ–°çš„ç”¨æˆ·ååˆ—è¡¨
    def add_username_to_last_username_list(data):
        global last_username_list

        # æ·»åŠ æ•°æ®åˆ° æœ€æ–°å…¥åœºçš„ç”¨æˆ·ååˆ—è¡¨
        last_username_list.append(data)
        
        # ä¿ç•™æœ€æ–°çš„3ä¸ªæ•°æ®
        last_username_list = last_username_list[-3:]


    # å®šæ—¶ä»»åŠ¡
    def schedule_task(index):
        global config, common, my_handle, last_liveroom_data, last_username_list

        logging.debug("å®šæ—¶ä»»åŠ¡æ‰§è¡Œä¸­...")
        hour, min = common.get_bj_time(6)

        if 0 <= hour and hour < 6:
            time = f"å‡Œæ™¨{hour}ç‚¹{min}åˆ†"
        elif 6 <= hour and hour < 9:
            time = f"æ—©æ™¨{hour}ç‚¹{min}åˆ†"
        elif 9 <= hour and hour < 12:
            time = f"ä¸Šåˆ{hour}ç‚¹{min}åˆ†"
        elif hour == 12:
            time = f"ä¸­åˆ{hour}ç‚¹{min}åˆ†"
        elif 13 <= hour and hour < 18:
            time = f"ä¸‹åˆ{hour - 12}ç‚¹{min}åˆ†"
        elif 18 <= hour and hour < 20:
            time = f"å‚æ™š{hour - 12}ç‚¹{min}åˆ†"
        elif 20 <= hour and hour < 24:
            time = f"æ™šä¸Š{hour - 12}ç‚¹{min}åˆ†"


        # æ ¹æ®å¯¹åº”ç´¢å¼•ä»åˆ—è¡¨ä¸­éšæœºè·å–ä¸€ä¸ªå€¼
        random_copy = random.choice(config.get("schedule")[index]["copy"])

        # å‡è®¾æœ‰å¤šä¸ªæœªçŸ¥å˜é‡ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ­¤å¤„å®šä¹‰åŠ¨æ€å˜é‡
        variables = {
            'time': time,
            'user_num': "N",
            'last_username': last_username_list[-1],
        }

        # ä½¿ç”¨å­—å…¸è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢
        if any(var in random_copy for var in variables):
            content = random_copy.format(**{var: value for var, value in variables.items() if var in random_copy})
        else:
            content = random_copy

        data = {
            "username": None,
            "content": content
        }

        logging.info(f"å®šæ—¶ä»»åŠ¡ï¼š{content}")

        my_handle.process_data(data, "schedule")


    # å¯åŠ¨å®šæ—¶ä»»åŠ¡
    def run_schedule():
        try:
            for index, task in enumerate(config.get("schedule")):
                if task["enable"]:
                    # print(task)
                    # è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”nç§’æ‰§è¡Œä¸€æ¬¡
                    schedule.every(task["time"]).seconds.do(partial(schedule_task, index))
        except Exception as e:
            logging.error(e)

        while True:
            schedule.run_pending()
            # time.sleep(1)  # æ§åˆ¶æ¯æ¬¡å¾ªç¯çš„é—´éš”æ—¶é—´ï¼Œé¿å…è¿‡å¤šå ç”¨ CPU èµ„æº


    # åˆ›å»ºå®šæ—¶ä»»åŠ¡å­çº¿ç¨‹å¹¶å¯åŠ¨
    schedule_thread = threading.Thread(target=run_schedule)
    schedule_thread.start()


    async def on_message(websocket, path):
        global last_liveroom_data, last_username_list

        async for message in websocket:
            # print(f"æ”¶åˆ°æ¶ˆæ¯: {message}")
            # await websocket.send("æœåŠ¡å™¨æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯: " + message)

            try:
                data_json = json.loads(message)
                # logging.debug(data_json)
                if data_json["type"] == "commit":
                    # logging.info(data_json)

                    user_name = data_json["username"]
                    content = data_json["content"]
                    
                    logging.info(f'[ğŸ“§ç›´æ’­é—´å¼¹å¹•æ¶ˆæ¯] [{user_name}]ï¼š{content}')

                    data = {
                        "username": user_name,
                        "content": content
                    }
                    
                    my_handle.process_data(data, "commit")

                    # æ·»åŠ ç”¨æˆ·ååˆ°æœ€æ–°çš„ç”¨æˆ·ååˆ—è¡¨
                    add_username_to_last_username_list(user_name)

            except Exception as e:
                logging.error(e)
                logging.error("æ•°æ®è§£æé”™è¯¯ï¼")
                continue
        

    async def ws_server():
        ws_url = "127.0.0.1"
        ws_port = 5000
        server = await websockets.serve(on_message, ws_url, ws_port)
        logging.info(f"WebSocket æœåŠ¡å™¨å·²åœ¨ {ws_url}:{ws_port} å¯åŠ¨")
        await server.wait_closed()


    asyncio.run(ws_server())


if __name__ == '__main__':
    start_server()